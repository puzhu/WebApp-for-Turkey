<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<title>Turkey Survey Charts</title>
<script src="libraries/d3.v3.min.js"></script>
<script src="libraries/topojson.v1.min.js"></script>
<script src="libraries/queue.v1.min.js"></script>
<script src="libraries/jquery-1.8.3.min.js"></script>
<script src="libraries/d3.tip.v0.6.3.js"></script>
<link rel="stylesheet" href="libraries/tool-tip-style.css">
<link rel="stylesheet" href="libraries/main.css">
<script src="http://d3js.org/topojson.v1.min.js"></script>
<style>

</style>
</head>

<body>
	<div id="main">
		<div class='controls'>
			<form action="">
				<input type="radio" name="mapLevel" value=1>Nuts 1
				<input type="radio" name="mapLevel" value=2 checked="checked">Nuts 2
				<input type="radio" name="mapLevel" value=3>Nuts 3
			</form>
		</div>
		<div id="mapContainer"></div>
		<div id="chartContainer"></div>
	</div>
</body>

<script>


//LISTENING TO THE RADIO BUTTON TO REGISTER NEW MAP VALUES AND CHANGE THE DATA QUEUE ND DRAWING THE MAP



queue()
	.defer(d3.json, "maps/nuts1.json") //the zone map
	.defer(d3.json, "maps/nuts2.json")
	.defer(d3.json, "maps/nuts3.json")
	.defer(d3.csv, "data/nutsData.csv")
	.await(ready);

function ready(error, mapFile1, mapFile2, mapFile3, nutsData){
	drawMap(mapFile1, mapFile2, mapFile3, nutsData)
}


function drawMap(mapFile1, mapFile2, mapFile3, nutsData){
	//CREATING THE CANVAS
	var containerSize = d3.select('#mapContainer').node().getBoundingClientRect()
  	var mapMargin = {top: 0.008*containerSize.height , right: 0.008*containerSize.width, bottom: 0.008*containerSize.height, left: 0.008*containerSize.width};
  	var mapWidth = containerSize.width - mapMargin.right - mapMargin.left; //Chart width
  	var mapHeight = containerSize.height - mapMargin.top - mapMargin.bottom; //Chart height

  	var map = d3.select('#mapContainer').append('svg') //http://bl.ocks.org/mbostock/3019563
        .attr({
          height: mapHeight + mapMargin.top + mapMargin.bottom,
          width: mapWidth + mapMargin.left + mapMargin.right
        })
        .attr("id", "mapSvg")
      	.attr("transform", "translate(" + (mapMargin.left) + "," + (mapMargin.top)+ ")")//moving the origin to the point where it starts
      	//.call(makeResponsiveMap)

	//GETTING THE MAP DATA READY
	var nutsLevel = Number($("input[type='radio'][name='mapLevel']:checked").val())
	var mapFile = mapFile2
	
	var mapKey = Object.keys(mapFile.objects)//Pulls out the key associated with the map features
	var mapFeatures = topojson.feature(mapFile, mapFile.objects[mapKey]).features
	//console.log(mapFeatures)

	//SETTING THE MAP PROJECTION AND PATH
	var mapProjection = d3.geo.mercator()
		.scale(800) //(d3.min([2.5*mapWidth,2*mapHeight]))
		.translate([-0.15*mapWidth, 4.15*mapHeight])

	var mapPath = d3.geo.path()
		.projection(mapProjection)

	//DRAWING THE MAP
	var turkeyMap = map.append('g').selectAll('.turkeyMap') //the large map with zone boundaries
		.data(mapFeatures)
		.enter()
		.append('path')
		.attr({
			d: mapPath,
			'class': 'turkeyMap',
			fill: "#DFDFDF",
		});

		//turkey map .style create a function if d.id = AT_~

	//DRAWING BOUNDARIES
	var internalBoundaries = map.append("path") //the zonal boundaries
		.datum(topojson.mesh(mapFile, mapFile.objects[mapKey], function(a, b) { return a !== b}))
		.attr({
			d: mapPath,
			class: 'country-boundary'
		});

	//LISTEN TO THE RADIO BUTTON AND REDRAW MAP BASED ON CLICKS
	$('input:radio').on('click', function(e) {
		if(e.currentTarget.name === "mapLevel"){
			var nutsLevel = Number(e.currentTarget.value);
			console.log(nutsLevel)
			//$( "#mapContainer" ).empty()
			if (nutsLevel === 1) {
				mapFile = mapFile1
			} else if (nutsLevel === 2) {
				mapFile = mapFile2
			} else {
				mapFile = mapFile3
			}
		}
		redrawMap(mapFile, nutsData)

	});
	function redrawMap(mapFile, nutsData){
		
		mapKey = Object.keys(mapFile.objects)
		mapFeatures = topojson.feature(mapFile, mapFile.objects[mapKey]).features
		

		turkeyMap.data(mapFeatures)

		internalBoundaries.remove()
		internalBoundaries.append('path')
		internalBoundaries.datum(topojson.mesh(mapFile, mapFile.objects[mapKey], function(a, b) { return a !== b}))
		internalBoundaries.attr({
				d: mapPath,
				class: 'country-boundary'
			});
	}
}


</script>
</html>
